<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>ÂÖ¨ÂºÄÂçöÂÆ¢</title>
    <style>
      :root {
        font-family: "Segoe UI", "PingFang SC", "Microsoft YaHei", Arial, sans-serif;
        color-scheme: light;
        --bg: #f7f7fb;
        --card-rgb: 255, 255, 255;
        --card-opacity: 0.4;
        --card: rgba(var(--card-rgb), var(--card-opacity));
        --text: #1f2328;
        --muted: #6b7280;
        --node-color: #2563eb;
        --primary: var(--node-color);
        --border: rgba(229, 231, 235, 0.5);
        --backdrop-blur: 10px;
        --shadow: rgba(0, 0, 0, 0.1);
      }
      html.dark {
        color-scheme: dark;
        --bg: #111827;
        --card-rgb: 31, 41, 55;
        --text: #f3f4f6;
        --muted: #9ca3af;
        --border: rgba(75, 85, 99, 0.5);
        --shadow: rgba(0, 0, 0, 0.3);
      }
      body {
        margin: 0;
        background: var(--bg);
        color: var(--text);
        min-height: 100vh;
        transition: color 0.3s, background-color 0.3s;
      }
      .hero-bg {
        position: fixed;
        top: 0; left: 0; width: 100%;
        height: 40vh;
        background-size: cover;
        background-position: center;
        z-index: -1;
        transition: filter 0.3s;
        pointer-events: none;
      }
      .hero-bg::after {
        content: '';
        position: absolute;
        bottom: 0; left: 0; right: 0;
        height: 50%;
        background: linear-gradient(to bottom, transparent, var(--bg));
      }
      html.dark .hero-bg {
        filter: brightness(0.5);
      }
      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 24px;
        padding-top: 120px; /* Adjusted for blog view */
        display: grid;
        grid-template-columns: 300px 1fr;
        gap: 24px;
        align-items: start;
        position: relative;
        min-height: 100vh;
        box-sizing: border-box;
        transition: opacity 0.4s ease, transform 0.4s ease;
      }
      
      /* Intro View */
      .intro-container {
        position: fixed;
        top: 0; left: 0; right: 0; bottom: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10;
        padding: 20px;
        transition: opacity 0.4s ease, transform 0.4s ease;
      }
      .intro-card {
        text-align: center;
        max-width: 400px;
        width: 100%;
        padding: 40px;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 24px;
      }
      .intro-content {
        display: flex;
        flex-direction: column;
        align-items: center;
        width: 100%;
      }
      .intro-name {
        font-size: 32px;
        font-weight: bold;
        margin: 0 0 16px 0;
        background: linear-gradient(135deg, var(--text) 0%, var(--primary) 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
      }
      .intro-text {
        color: var(--muted);
        margin-bottom: 32px;
        line-height: 1.8;
        white-space: pre-wrap;
        font-size: 16px;
      }
      
      @media (min-width: 769px) {
        .intro-card {
            max-width: 1100px;
            flex-direction: row;
            text-align: left;
            padding: 80px;
            gap: 80px;
            align-items: center;
        }
        .intro-card .avatar {
            width: 320px;
            height: 320px;
            border-width: 8px;
            flex-shrink: 0;
            box-shadow: 0 20px 40px -10px var(--shadow);
        }
        .intro-content {
            align-items: flex-start;
            flex: 1;
        }
        .intro-name {
            font-size: 72px;
            margin-bottom: 24px;
            letter-spacing: -2px;
        }
        .intro-text {
            font-size: 20px;
            margin-bottom: 48px;
            max-width: 600px;
        }
        .enter-btn {
            font-size: 22px;
            padding: 18px 56px;
        }
      }
      .enter-btn {
        font-size: 18px;
        padding: 12px 32px;
        border-radius: 999px;
        background: var(--primary);
        color: white;
        border: none;
        cursor: pointer;
        transition: transform 0.2s, opacity 0.2s;
        text-decoration: none;
      }
      .enter-btn:hover {
        transform: scale(1.05);
        opacity: 0.9;
      }

      /* Back Button */
      .back-home-btn {
        position: absolute;
        top: 24px;
        left: 24px;
        background: var(--card);
        backdrop-filter: blur(var(--backdrop-blur));
        border: 1px solid var(--border);
        padding: 8px 16px;
        border-radius: 8px;
        cursor: pointer;
        color: var(--text);
        font-size: 14px;
        display: flex;
        align-items: center;
        gap: 6px;
        transition: all 0.2s;
        z-index: 20;
        box-shadow: 0 2px 4px var(--shadow);
      }
      .back-home-btn:hover {
        transform: translateX(-2px);
        background: rgba(255, 255, 255, 0.8);
      }
      html.dark .back-home-btn:hover {
        background: rgba(31, 41, 55, 0.8);
      }

      @media (max-width: 768px) {
        .container {
          grid-template-columns: 1fr;
          padding-top: 80px;
        }
        .profile-card {
          display: none; /* Hide sidebar on mobile */
        }
        .back-home-btn {
            top: 16px;
            left: 16px;
        }
      }
      .glass-panel {
        /* Acrylic Effect */
        background: rgba(255, 255, 255, 0.4);
        backdrop-filter: blur(20px) saturate(180%);
        -webkit-backdrop-filter: blur(20px) saturate(180%);
        border: 1px solid rgba(255, 255, 255, 0.4);
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.1);
        transition: transform 0.3s ease, box-shadow 0.3s ease, background-color 0.3s;
      }
      html.dark .glass-panel {
        background: rgba(31, 41, 55, 0.4);
        border: 1px solid rgba(255, 255, 255, 0.1);
        box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
      }
      .glass-panel:hover {
        transform: scale(1.02);
        box-shadow: 0 10px 15px -3px var(--shadow), 0 4px 6px -2px rgba(0, 0, 0, 0.1);
      }
      /* Profile Section */
      .profile-card {
        text-align: center;
        position: sticky;
        top: 24px;
      }
      .avatar {
        width: 120px;
        height: 120px;
        border-radius: 50%;
        object-fit: cover;
        margin-bottom: 16px;
        border: 4px solid var(--border);
        background-color: var(--muted);
      }
      .profile-name {
        font-size: 24px;
        font-weight: bold;
        margin: 0 0 8px 0;
      }
      .profile-intro {
        color: var(--muted);
        font-size: 14px;
        line-height: 1.6;
        white-space: pre-wrap;
      }
      
      /* Main Content */
      .main-content {
        display: grid;
        gap: 20px;
      }
      .timeline-item {
        margin-bottom: 32px;
        position: relative;
        padding-left: 20px;
        border-left: 2px solid rgba(229, 231, 235, 0.5);
      }
      .timeline-date {
        font-size: 14px;
        font-weight: 600;
        color: var(--muted);
        margin-bottom: 8px;
        position: relative;
        display: flex;
        align-items: center;
      }
      .timeline-date::before {
        content: '';
        position: absolute;
        left: -26px;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background: var(--primary);
        border: 2px solid #fff;
      }
      .post-card {
        border-radius: 16px;
      }
      .post-title {
        margin: 0 0 8px 0;
        font-size: 18px;
        font-weight: 600;
      }
      .post-title a {
        color: var(--text);
        text-decoration: none;
      }
      .post-title a:hover {
        color: var(--primary);
      }
      .post-summary {
        color: #4b5563;
        font-size: 14px; /* Smaller font size */
        line-height: 1.6;
      }
      .read-more {
        display: inline-block;
        margin-top: 12px;
        color: var(--primary);
        text-decoration: none;
        font-size: 14px;
      }
      
      /* Post Detail (Inline) */
      .post-detail {
        margin-top: 0;
        padding-top: 0;
        border-top: none;
        animation: slideDown 0.3s ease-out;
      }
      .post-content {
        line-height: 1.8;
        font-size: 16px;
        margin-bottom: 24px;
        color: var(--text);
      }
      .post-content pre {
        background: rgba(0, 0, 0, 0.05);
        padding: 16px;
        border-radius: 8px;
        overflow-x: auto;
      }
      
      /* Comments */
      .comment-section {
        background: rgba(0,0,0,0.02);
        border-radius: 8px;
        padding: 16px;
      }
      .comment-list {
        display: grid;
        gap: 16px;
        margin-top: 16px;
      }
      @keyframes slideDown {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
      }
      .comment-item {
        border-bottom: 1px solid var(--border);
        padding-bottom: 16px;
      }
      .comment-item:last-child {
        border-bottom: none;
      }

      /* Modal */
      .modal {
        position: fixed;
        top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        backdrop-filter: blur(4px);
        -webkit-backdrop-filter: blur(4px);
      }
      
      /* Settings Menu */
      .settings-container {
        position: fixed;
        top: 24px;
        right: 24px;
        z-index: 1000;
        display: flex;
        flex-direction: column;
        align-items: flex-end;
      }
      .settings-btn {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: var(--card);
        border: 1px solid var(--border);
        cursor: pointer;
        font-size: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        backdrop-filter: blur(var(--backdrop-blur));
        box-shadow: 0 2px 4px var(--shadow);
        transition: transform 0.3s;
        padding: 0;
      }
      .settings-btn:hover {
        transform: rotate(90deg);
      }
      .settings-menu {
        margin-top: 12px;
        background: var(--card);
        backdrop-filter: blur(var(--backdrop-blur));
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 8px;
        display: flex;
        flex-direction: column;
        gap: 4px;
        min-width: 180px;
        box-shadow: 0 4px 12px var(--shadow);
        transform-origin: top right;
        transition: opacity 0.2s, transform 0.2s;
      }
      .settings-menu.hidden {
        display: none;
      }
      .menu-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 10px 12px;
        border-radius: 8px;
        cursor: pointer;
        background: transparent;
        border: none;
        color: var(--text);
        font-size: 14px;
        text-align: left;
        width: 100%;
        font-family: inherit;
      }
      .menu-item:hover {
        background: rgba(0,0,0,0.05);
      }
      html.dark .menu-item:hover {
        background: rgba(255,255,255,0.1);
      }
      .menu-icon {
        width: 20px;
        text-align: center;
      }
      .modal-content {
        width: 90%;
        max-width: 500px;
        display: flex;
        flex-direction: column;
        gap: 16px;
      }
      
      /* Form Elements */
      input, textarea {
        width: 100%;
        background: var(--card);
        color: var(--text);
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 10px;
        font-family: inherit;
        box-sizing: border-box;
        transition: background 0.2s, border-color 0.2s;
      }
      input:focus, textarea:focus {
        background: var(--bg);
        outline: 2px solid var(--primary);
        outline-offset: -1px;
      }
      button {
        padding: 10px 20px;
        border: none;
        border-radius: 8px;
        background: var(--primary);
        color: white;
        cursor: pointer;
        font-weight: 500;
        transition: opacity 0.2s;
      }
      button:hover {
        opacity: 0.9;
      }
      
      /* Pagination */
      .pagination {
        display: flex;
        justify-content: center;
        gap: 8px;
        margin-top: 24px;
        position: relative;
        z-index: 10;
      }
      .page-btn {
        padding: 8px 12px;
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 6px;
        color: var(--text);
        text-decoration: none;
        cursor: pointer;
      }
      .page-btn.active {
        background: var(--primary);
        color: white;
        border-color: var(--primary);
      }
      .page-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .hidden { display: none; }
      .image-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 16px;
        margin-top: 16px;
      }
      .image-grid img {
        width: 100%;
        border-radius: 8px;
        border: 1px solid var(--border);
      }
      @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
      }
      @keyframes slideUp {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
      }
    </style>
  </head>
  <body>
    <div id="heroBg" class="hero-bg"></div>
    <div class="settings-container">
      <button id="settingsToggle" class="settings-btn" title="ËÆæÁΩÆ">‚öôÔ∏è</button>
      <div id="settingsMenu" class="settings-menu hidden">
        <button id="themeToggle" class="menu-item">
          <span class="menu-icon">üåì</span> ÂàáÊç¢‰∏ªÈ¢ò
        </button>
        <button id="snowToggle" class="menu-item">
          <span class="menu-icon">‚ùÑÔ∏è</span> Èõ™Ëä±ÁâπÊïà
        </button>
        <div id="musicControlContainer" class="hidden">
           <!-- Music Player will mount here -->
        </div>
      </div>
    </div>
    
    <!-- Intro View -->
    <div id="introView" class="intro-container hidden">
        <div class="glass-panel intro-card">
            <img id="introAvatar" src="" alt="Avatar" class="avatar hidden" />
            <div class="intro-content">
                <h1 id="introName" class="intro-name">Loading...</h1>
                <div id="introText" class="intro-text"></div>
                <button id="enterBlogBtn" class="enter-btn">ËøõÂÖ•ÂçöÂÆ¢</button>
            </div>
        </div>
    </div>

    <!-- Blog View -->
    <div id="blogView" class="container hidden">
      <button id="backHomeBtn" class="back-home-btn">‚Üê Back to Home</button>
      
      <!-- Left Sidebar: Profile -->
      <aside class="glass-panel profile-card">
        <img id="profileAvatar" src="" alt="Avatar" class="avatar hidden" />
        <h2 id="profileName" class="profile-name">Loading...</h2>
        <div id="profileIntro" class="profile-intro"></div>
      </aside>

      <!-- Right Content: Posts List -->
      <main class="main-content">
        <div id="postList"></div>
        <div id="pagination" class="pagination hidden">
          <button id="prevPage" class="page-btn">‰∏ä‰∏ÄÈ°µ</button>
          <span id="pageInfo" style="display: flex; align-items: center;">1 / 1</span>
          <button id="nextPage" class="page-btn">‰∏ã‰∏ÄÈ°µ</button>
        </div>
      </main>
    </div>

    <!-- Comment Modal -->
    <div id="commentModal" class="modal hidden">
      <div class="glass-panel modal-content">
        <h3 style="margin: 0;">ÂèëË°®ËØÑËÆ∫</h3>
        <textarea id="commentContent" rows="5" placeholder="ÂÜô‰∏ã‰Ω†ÁöÑËØÑËÆ∫..."></textarea>
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <span id="commentStatus" class="meta" style="margin: 0;"></span>
          <div style="display: flex; gap: 8px;">
            <button id="closeCommentBtn" style="background: #6b7280;">ÂèñÊ∂à</button>
            <button id="submitCommentBtn">Êèê‰∫§</button>
          </div>
        </div>
      </div>
    </div>

    <script src="/web/snow.js"></script>
    <script src="/web/music.js"></script>
    <script>
      // State
      let currentPage = 1;
      const pageSize = 10;
      let totalPosts = 0;
      let currentCommentPostId = null; // Track which post is being commented on

      // Elements
      const els = {
        avatar: document.getElementById("profileAvatar"),
        name: document.getElementById("profileName"),
        intro: document.getElementById("profileIntro"),
        introView: document.getElementById("introView"),
        introAvatar: document.getElementById("introAvatar"),
        introName: document.getElementById("introName"),
        introText: document.getElementById("introText"),
        enterBlogBtn: document.getElementById("enterBlogBtn"),
        blogView: document.getElementById("blogView"),
        backHomeBtn: document.getElementById("backHomeBtn"),
        postList: document.getElementById("postList"),
        pagination: document.getElementById("pagination"),
        prevPage: document.getElementById("prevPage"),
        nextPage: document.getElementById("nextPage"),
        pageInfo: document.getElementById("pageInfo"),
        commentContent: document.getElementById("commentContent"),
        commentStatus: document.getElementById("commentStatus"),
        submitCommentBtn: document.getElementById("submitCommentBtn"),
        commentModal: document.getElementById("commentModal"),
        closeCommentBtn: document.getElementById("closeCommentBtn"),
      };

      // Utils
      function getPostIdFromUrl() {
        const match = window.location.pathname.match(/\/post\/(\d+)/);
        if (match) return match[1];
        const url = new URL(window.location.href);
        return url.searchParams.get("post_id");
      }

      // Color Extraction
      function extractDominantColor(imageUrl) {
        return new Promise((resolve, reject) => {
          const img = new Image();
          img.crossOrigin = "Anonymous";
          img.src = imageUrl;
          img.onload = () => {
            try {
              const canvas = document.createElement("canvas");
              canvas.width = 1;
              canvas.height = 1;
              const ctx = canvas.getContext("2d");
              ctx.drawImage(img, 0, 0, 1, 1);
              const [r, g, b] = ctx.getImageData(0, 0, 1, 1).data;
              resolve(`rgb(${r}, ${g}, ${b})`);
            } catch (e) {
              reject(e);
            }
          };
          img.onerror = reject;
        });
      }

      // Settings Toggle
      const settingsToggle = document.getElementById("settingsToggle");
      const settingsMenu = document.getElementById("settingsMenu");
      
      settingsToggle.addEventListener("click", (e) => {
        e.stopPropagation();
        settingsMenu.classList.toggle("hidden");
      });

      document.addEventListener("click", (e) => {
        if (!settingsMenu.contains(e.target) && e.target !== settingsToggle) {
          settingsMenu.classList.add("hidden");
        }
      });

      // Theme Management
      const themeToggle = document.getElementById("themeToggle");
      
      function initTheme() {
        const saved = localStorage.getItem("theme");
        if (saved === "dark" || (!saved && window.matchMedia("(prefers-color-scheme: dark)").matches)) {
          document.documentElement.classList.add("dark");
        }
      }

      themeToggle.addEventListener("click", () => {
        document.documentElement.classList.toggle("dark");
        const isDark = document.documentElement.classList.contains("dark");
        localStorage.setItem("theme", isDark ? "dark" : "light");
      });

      // Snow Management
      const snowToggle = document.getElementById("snowToggle");
      let isSnowEnabled = false;

      function initSnow(defaultEnabled) {
        const saved = localStorage.getItem("snow");
        // If user has a preference, use it. Otherwise use admin default.
        if (saved !== null) {
          isSnowEnabled = saved === "true";
        } else {
          isSnowEnabled = !!defaultEnabled;
        }
        applySnowState();
      }

      function applySnowState() {
        if (isSnowEnabled) {
          window.snowEffect && window.snowEffect.start();
          snowToggle.querySelector('.menu-icon').style.opacity = "1";
        } else {
          window.snowEffect && window.snowEffect.stop();
          snowToggle.querySelector('.menu-icon').style.opacity = "0.3";
        }
      }

      snowToggle.addEventListener("click", () => {
        isSnowEnabled = !isSnowEnabled;
        localStorage.setItem("snow", isSnowEnabled);
        applySnowState();
      });

      function renderImages(images) {
        if (!images || images.length === 0) return "";
        const items = images
          .map((url) => `<div><img src="${url}" alt="image" loading="lazy" /></div>`)
          .join("");
        return `<div class="image-grid">${items}</div>`;
      }

      function formatDate(isoString) {
        if (!isoString) return "";
        return new Date(isoString).toLocaleString("zh-CN", { hour12: false });
      }

      // API Calls
      async function loadSettings() {
        try {
          const resp = await fetch("/api/v1/settings");
          const { data } = await resp.json();
          
          const name = data.name || "Êú™ÂëΩÂêçÂçöÂÆ¢";
          const intro = data.intro || "ÊöÇÊó†ÁÆÄ‰ªã";
          
          // Update Profile Sidebar
          els.name.textContent = name;
          els.intro.textContent = intro;
          if (data.avatar) {
            els.avatar.src = data.avatar;
            els.avatar.classList.remove("hidden");
          }

          // Update Intro View
          els.introName.textContent = name;
          els.introText.textContent = intro;
          if (data.avatar) {
            els.introAvatar.src = data.avatar;
            els.introAvatar.classList.remove("hidden");
          }

          if (data.background_image) {
            document.getElementById("heroBg").style.backgroundImage = `url('${data.background_image}')`;
          }
          
          // Apply Configured Colors/Opacity
          if (data.card_opacity !== undefined && data.card_opacity !== null) {
             document.documentElement.style.setProperty('--card-opacity', data.card_opacity);
          }
          
          if (data.node_color) {
             document.documentElement.style.setProperty('--node-color', data.node_color);
          } else if (data.theme_color) {
             // Fallback to theme_color if node_color not set, or just use it as primary
             document.documentElement.style.setProperty('--node-color', data.theme_color);
          }

          // Initialize Snow Effect
          initSnow(data.enable_snow);

          // Initialize Music Player
          if (data.music_url && window.musicPlayer) {
            const musicContainer = document.getElementById("musicControlContainer");
            musicContainer.classList.remove("hidden");
            window.musicPlayer.init(data.music_url, musicContainer);
          }

        } catch (err) {
          console.error("Failed to load settings", err);
        }
      }

      async function loadPosts(page) {
        // Only show loading if list is empty
        if (!els.postList.children.length) {
            els.postList.innerHTML = '<div class="glass-panel" style="text-align:center; color:var(--muted);">Âä†ËΩΩ‰∏≠...</div>';
        }
        try {
          const resp = await fetch(`/api/v1/posts?page=${page}&size=${pageSize}`);
          const { data, total } = await resp.json();
          
          totalPosts = total || 0;
          renderPostList(data || []);
          updatePagination();
          
          // Check if we need to expand a post based on URL
          const postId = getPostIdFromUrl();
          if (postId) {
            togglePost(postId, false); // false = don't toggle off if already open
          }
        } catch (err) {
          els.postList.innerHTML = '<div class="glass-panel" style="text-align:center; color:red;">Âä†ËΩΩÂ§±Ë¥•</div>';
        }
      }

      function renderPostList(posts) {
        if (posts.length === 0) {
          els.postList.innerHTML = '<div class="glass-panel" style="text-align:center; color:var(--muted);">ÊöÇÊó†ÊñáÁ´†</div>';
          return;
        }
        
        els.postList.innerHTML = posts.map(post => `
          <div class="timeline-item">
            <div class="timeline-date">${formatDate(post.created_at)}</div>
            <article class="glass-panel post-card" id="post-card-${post.id}">
              <h3 class="post-title">
                <a href="/post/${post.id}" onclick="event.preventDefault(); togglePost(${post.id});">${post.title}</a>
              </h3>
              <p class="post-summary">${post.summary || ""}</p>
              
              <div id="post-detail-${post.id}" class="post-detail hidden">
                 <div id="post-content-${post.id}" class="post-content">Âä†ËΩΩ‰∏≠...</div>
                 <div class="comment-section">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <h4 style="margin:0;">ËØÑËÆ∫</h4>
                        <button onclick="openCommentModal(${post.id})" style="padding: 4px 10px; font-size: 12px;">ÂÜôËØÑËÆ∫</button>
                    </div>
                    <div id="post-comments-${post.id}" class="comment-list"></div>
                 </div>
                 <div style="text-align:center; margin-top:20px;">
                    <button onclick="togglePost(${post.id})" style="background:transparent; border:1px solid var(--primary); color:var(--primary);">Êî∂Ëµ∑</button>
                 </div>
              </div>

              <button onclick="togglePost(${post.id})" class="read-more" style="background:none; border:none; padding:0; cursor:pointer; font-family:inherit;">ÈòÖËØªÂÖ®Êñá ‚Üí</button>
            </article>
          </div>
        `).join("");
      }

      function updatePagination() {
        const totalPages = Math.ceil(totalPosts / pageSize);
        if (totalPages <= 1) {
          els.pagination.classList.add("hidden");
          return;
        }
        
        els.pagination.classList.remove("hidden");
        els.pageInfo.textContent = `${currentPage} / ${totalPages}`;
        els.prevPage.disabled = currentPage <= 1;
        els.nextPage.disabled = currentPage >= totalPages;
      }

      async function togglePost(postId, toggleOff = true) {
        const detailEl = document.getElementById(`post-detail-${postId}`);
        const readMoreBtn = document.querySelector(`#post-card-${postId} .read-more`);
        const summaryEl = document.querySelector(`#post-card-${postId} .post-summary`);
        
        if (!detailEl) return;

        const isHidden = detailEl.classList.contains("hidden");
        
        if (!isHidden && toggleOff) {
            // Collapse
            detailEl.classList.add("hidden");
            readMoreBtn.classList.remove("hidden");
            if (summaryEl) summaryEl.classList.remove("hidden");
            history.pushState(null, "", "/");
            return;
        }

        // Expand
        // Close others to keep view clean.
        document.querySelectorAll('.post-detail').forEach(el => {
            if (el.id !== `post-detail-${postId}`) el.classList.add('hidden');
        });
        document.querySelectorAll('.read-more').forEach(el => el.classList.remove('hidden'));
        document.querySelectorAll('.post-summary').forEach(el => el.classList.remove('hidden'));

        detailEl.classList.remove("hidden");
        readMoreBtn.classList.add("hidden");
        if (summaryEl) summaryEl.classList.add("hidden");
        
        // Update URL
        history.pushState(null, "", `/post/${postId}`);

        // Load content if empty
        const contentEl = document.getElementById(`post-content-${postId}`);
        if (contentEl.innerHTML === "Âä†ËΩΩ‰∏≠..." || contentEl.innerHTML === "") {
            try {
                const resp = await fetch(`/api/v1/posts/${postId}`);
                const { data: post } = await resp.json();
                if (post) {
                    contentEl.innerHTML = `
                        <div style="white-space: pre-wrap;">${post.content}</div>
                        ${renderImages(post.images)}
                    `;
                    loadInlineComments(postId);
                } else {
                    contentEl.textContent = "Âä†ËΩΩÂ§±Ë¥•";
                }
            } catch (e) {
                contentEl.textContent = "ÁΩëÁªúÈîôËØØ";
            }
        }
      }

      async function loadInlineComments(postId) {
        const listEl = document.getElementById(`post-comments-${postId}`);
        try {
          const resp = await fetch(`/api/v1/comments/public?post_id=${postId}`);
          const { data } = await resp.json();
          
          if (!data || data.length === 0) {
            listEl.innerHTML = '<div style="color:var(--muted); font-size:14px;">ÊöÇÊó†ËØÑËÆ∫</div>';
            return;
          }

          listEl.innerHTML = data.map(c => `
            <div class="comment-item">
              <div class="meta" style="margin-bottom:4px; font-size:12px;">${formatDate(c.created_at)}</div>
              <div style="white-space: pre-wrap; font-size:14px;">${c.content}</div>
            </div>
          `).join("");
        } catch (err) {
          console.error(err);
        }
      }

      function openCommentModal(postId) {
        currentCommentPostId = postId;
        els.commentModal.classList.remove("hidden");
        els.commentContent.focus();
      }

      async function submitComment() {
        // Use currentCommentPostId if available (for modal), otherwise try URL (fallback)
        const postId = currentCommentPostId || getPostIdFromUrl();
        if (!postId) return;

        const content = els.commentContent.value.trim();
        
        if (!content) return;
        
        els.submitCommentBtn.disabled = true;
        els.commentStatus.textContent = "Êèê‰∫§‰∏≠...";
        
        try {
          const resp = await fetch("/api/v1/comments/public", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ post_id: Number(postId), content })
          });
          
          if (resp.ok) {
            els.commentContent.value = "";
            els.commentStatus.textContent = "ËØÑËÆ∫ÊàêÂäüÔºÅ";
            loadInlineComments(postId);
            setTimeout(() => {
                els.commentStatus.textContent = "";
                els.commentModal.classList.add("hidden");
            }, 1000);
          } else {
            els.commentStatus.textContent = "Êèê‰∫§Â§±Ë¥•";
          }
        } catch (err) {
          els.commentStatus.textContent = "ÁΩëÁªúÈîôËØØ";
        } finally {
          els.submitCommentBtn.disabled = false;
        }
      }

      // Event Listeners
      els.prevPage.addEventListener("click", () => {
        if (currentPage > 1) {
          currentPage--;
          loadPosts(currentPage);
          window.scrollTo(0, 0);
        }
      });

      els.nextPage.addEventListener("click", () => {
        const totalPages = Math.ceil(totalPosts / pageSize);
        if (currentPage < totalPages) {
          currentPage++;
          loadPosts(currentPage);
          window.scrollTo(0, 0);
        }
      });

      els.submitCommentBtn.addEventListener("click", submitComment);
      els.closeCommentBtn.addEventListener("click", () => {
        els.commentModal.classList.add("hidden");
      });
      
      els.enterBlogBtn.addEventListener("click", () => navigateTo("/blog"));
      els.backHomeBtn.addEventListener("click", () => navigateTo("/"));

      // SPA Navigation
      async function switchView(showEl, hideEl) {
        if (!showEl.classList.contains("hidden")) return;

        // Fade out
        if (!hideEl.classList.contains("hidden")) {
            hideEl.style.opacity = "0";
            hideEl.style.transform = "scale(0.98)";
            await new Promise(r => setTimeout(r, 400));
            hideEl.classList.add("hidden");
        }

        // Prepare show
        showEl.classList.remove("hidden");
        showEl.style.opacity = "0";
        showEl.style.transform = "scale(1.02)";
        
        // Force reflow
        void showEl.offsetWidth;

        // Fade in
        showEl.style.opacity = "1";
        showEl.style.transform = "scale(1)";
      }

      async function handleRoute() {
        const path = window.location.pathname;
        const postId = getPostIdFromUrl();
        const isIntro = (path === "/" && !postId);

        if (isIntro) {
            // Show Intro
            await switchView(els.introView, els.blogView);
            document.title = els.introName.textContent || "Welcome";
        } else {
            // Show Blog
            await switchView(els.blogView, els.introView);
            document.title = "Blog - " + (els.name.textContent || "");
            
            // Load posts if needed
            if (!els.postList.children.length) {
                await loadPosts(currentPage);
            }
            
            if (postId) {
                togglePost(postId, false);
            } else {
                // Ensure we are in list view state
                document.querySelectorAll('.post-detail').forEach(el => el.classList.add('hidden'));
                document.querySelectorAll('.read-more').forEach(el => el.classList.remove('hidden'));
                document.querySelectorAll('.post-summary').forEach(el => el.classList.remove('hidden'));
            }
        }
      }

      function navigateTo(url) {
        history.pushState(null, "", url);
        handleRoute();
      }

      window.addEventListener("popstate", handleRoute);

      // Init
      async function init() {
        initTheme();
        await loadSettings();
        handleRoute();
      }

      init();
    </script>
  </body>
</html>
