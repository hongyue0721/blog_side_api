<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>博客管理面板</title>
    <style>
      :root {
        color-scheme: light;
        font-family: "Segoe UI", "PingFang SC", "Microsoft YaHei", Arial, sans-serif;
        --bg: #f7f7fb;
        --card: #ffffff;
        --text: #1f2328;
        --muted: #6b7280;
        --primary: #2563eb;
        --border: #e5e7eb;
      }
      body {
        margin: 0;
        background: var(--bg);
        color: var(--text);
      }
      header {
        background: var(--card);
        border-bottom: 1px solid var(--border);
        padding: 16px 24px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 16px;
        flex-wrap: wrap;
      }
      h1 {
        margin: 0;
        font-size: 20px;
      }
      main {
        padding: 24px;
        display: grid;
        gap: 16px;
      }
      .panel {
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 16px;
      }
      .toolbar {
        display: flex;
        gap: 8px;
        align-items: center;
        flex-wrap: wrap;
      }
      .tabs {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }
      .tab {
        padding: 8px 12px;
        border-radius: 6px;
        border: 1px solid var(--border);
        background: #f3f4f6;
        cursor: pointer;
      }
      .tab.active {
        background: var(--primary);
        color: #fff;
        border-color: var(--primary);
      }
      input[type="text"] {
        padding: 8px 10px;
        border: 1px solid var(--border);
        border-radius: 6px;
        min-width: 240px;
      }
      button {
        padding: 8px 12px;
        border: none;
        border-radius: 6px;
        background: var(--primary);
        color: white;
        cursor: pointer;
      }
      button.secondary {
        background: #6b7280;
      }
      button.danger {
        background: #dc2626;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 12px;
        font-size: 14px;
      }
      th,
      td {
        border-bottom: 1px solid var(--border);
        text-align: left;
        padding: 8px;
        vertical-align: top;
      }
      th {
        background: #f3f4f6;
      }
      .muted {
        color: var(--muted);
      }
      .empty {
        padding: 12px;
        color: var(--muted);
      }
      .badge {
        display: inline-block;
        padding: 2px 8px;
        font-size: 12px;
        border-radius: 999px;
        background: #eef2ff;
        color: #3730a3;
      }
      .hidden {
        display: none;
      }
    </style>
  </head>
  <body>
    <header>
      <h1>博客管理面板</h1>
      <div class="tabs">
        <button class="tab active" data-tab="posts">博客管理</button>
        <button class="tab" data-tab="comments">评论管理</button>
      </div>
    </header>
    <main>
      <section class="panel">
        <div class="toolbar">
          <input id="adminPasswordInput" type="password" placeholder="管理端密码（config.toml）" />
          <button id="refreshBtn">刷新当前列表</button>
          <span id="status" class="muted"></span>
        </div>
      </section>

      <section id="postsPanel" class="panel">
        <h2>博客管理</h2>
        <div id="postsContainer" class="empty">暂无数据</div>
      </section>

      <section id="postDetailPanel" class="panel hidden">
        <h2>文章详情</h2>
        <div id="postDetail" class="empty">请选择文章查看</div>
      </section>

      <section id="commentsPanel" class="panel hidden">
        <h2>评论管理</h2>
        <div id="commentsContainer" class="empty">暂无数据</div>
      </section>
    </main>

    <script>
      const adminPasswordInput = document.getElementById("adminPasswordInput");
      const commentsContainer = document.getElementById("commentsContainer");
      const postsContainer = document.getElementById("postsContainer");
      const postDetail = document.getElementById("postDetail");
      const statusEl = document.getElementById("status");
      const tabs = document.querySelectorAll(".tab");
      const panels = {
        posts: document.getElementById("postsPanel"),
        comments: document.getElementById("commentsPanel"),
      };
      let activeTab = "posts";

      function setStatus(text) {
        statusEl.textContent = text;
      }

      function getHeaders() {
        const password = adminPasswordInput.value.trim();
        return password ? { "X-ADMIN-PASSWORD": password } : {};
      }

      function isAuthed() {
        return !!adminPasswordInput.value.trim();
      }

      function setActiveTab(tabName) {
        activeTab = tabName;
        tabs.forEach((tab) => {
          tab.classList.toggle("active", tab.dataset.tab === tabName);
        });
        Object.entries(panels).forEach(([key, panel]) => {
          panel.classList.toggle("hidden", key !== tabName);
        });
      }

      function renderTable(container, rows, columns) {
        if (!rows || rows.length === 0) {
          container.innerHTML = "<div class='empty'>暂无数据</div>";
          return;
        }
        const thead = `<thead><tr>${columns.map((c) => `<th>${c.title}</th>`).join("")}</tr></thead>`;
        const tbody = `<tbody>${rows
          .map((row) => {
            return `<tr>${columns
              .map((c) => `<td>${c.render ? c.render(row) : row[c.key] ?? ""}</td>`)
              .join("")}</tr>`;
          })
          .join("")}</tbody>`;
        container.innerHTML = `<table>${thead}${tbody}</table>`;
      }

      async function loadComments() {
        setStatus("正在加载评论列表...");
        try {
          const resp = await fetch(`/api/v1/comments`, { headers: getHeaders() });
          if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
          const data = await resp.json();
          renderTable(commentsContainer, data.data || [], [
            { title: "ID", key: "id" },
            { title: "文章", key: "post_title" },
            { title: "访客", key: "visitor_name" },
            { title: "评论", key: "content" },
            { title: "时间", key: "created_at" },
            {
              title: "操作",
              render: (row) => `
                <button data-action='comment-edit' data-id='${row.id}'>编辑</button>
                <button class='danger' data-action='comment-delete' data-id='${row.id}'>删除</button>
              `,
            },
          ]);
          bindCommentActions();
          setStatus("评论列表加载完成");
        } catch (err) {
          commentsContainer.innerHTML = `<div class='empty'>加载失败：${err.message}</div>`;
          setStatus("加载失败");
        }
      }

      async function loadPosts() {
        setStatus("正在加载博客列表...");
        try {
          const resp = await fetch(`/api/v1/posts`, { headers: getHeaders() });
          if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
          const data = await resp.json();
          renderTable(postsContainer, data.data || [], [
            { title: "ID", key: "id" },
            { title: "标题", key: "title" },
            { title: "作者", key: "author" },
            { title: "时间", key: "created_at" },
            {
              title: "操作",
              render: (row) => `
                <button data-action='view' data-id='${row.id}'>查看</button>
                <button data-action='edit' data-id='${row.id}'>编辑</button>
                <button class='danger' data-action='delete' data-id='${row.id}'>删除</button>
              `,
            },
          ]);
          bindPostActions();
          setStatus("博客列表加载完成");
        } catch (err) {
          postsContainer.innerHTML = `<div class='empty'>加载失败：${err.message}</div>`;
          setStatus("加载失败");
        }
      }

      async function deletePost(postId) {
        if (!postId) return;
        if (!confirm(`确定删除文章 ID=${postId} 吗？`)) return;
        setStatus("正在删除文章...");
        try {
          const resp = await fetch(`/api/v1/posts/${postId}`, {
            method: "DELETE",
            headers: getHeaders(),
          });
          if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
          const data = await resp.json();
          if (data.code !== 0) throw new Error(data.message || "删除失败");
          await loadPosts();
          setStatus("删除完成");
        } catch (err) {
          setStatus(`删除失败：${err.message}`);
        }
      }

      async function viewPost(postId) {
        if (!postId) return;
        setStatus("正在加载文章详情...");
        try {
          const resp = await fetch(`/api/v1/posts/${postId}`, { headers: getHeaders() });
          if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
          const data = await resp.json();
          if (!data.data) throw new Error("未找到文章");
          const post = data.data;
          postDetail.innerHTML = `
            <div class="meta">ID：${post.id} ｜ 作者：${post.author || ""} ｜ 时间：${post.created_at || ""}</div>
            <h3>${post.title || ""}</h3>
            <p>${post.summary || ""}</p>
            <pre style="white-space: pre-wrap;">${post.content || ""}</pre>
          `;
          setStatus("文章详情加载完成");
        } catch (err) {
          postDetail.innerHTML = `<div class='empty'>加载失败：${err.message}</div>`;
          setStatus("加载失败");
        }
      }

      async function editPost(postId) {
        const title = prompt("请输入新标题（留空则不修改）");
        const summary = prompt("请输入新摘要（留空则不修改）");
        const content = prompt("请输入新正文（留空则不修改）");
        const author = prompt("请输入作者（留空则不修改）");
        if (title === null && summary === null && content === null && author === null) return;

        const payload = {};
        if (title) payload.title = title;
        if (summary) payload.summary = summary;
        if (content) payload.content = content;
        if (author) payload.author = author;
        if (Object.keys(payload).length === 0) {
          setStatus("未填写任何修改内容");
          return;
        }

        setStatus("正在保存修改...");
        try {
          const resp = await fetch(`/api/v1/posts/${postId}`, {
            method: "PUT",
            headers: { "Content-Type": "application/json", ...getHeaders() },
            body: JSON.stringify(payload),
          });
          if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
          const data = await resp.json();
          if (data.code !== 0) throw new Error(data.message || "保存失败");
          await loadPosts();
          await viewPost(postId);
          setStatus("保存完成");
        } catch (err) {
          setStatus(`保存失败：${err.message}`);
        }
      }

      function bindPostActions() {
        postsContainer.querySelectorAll("button").forEach((btn) => {
          const action = btn.dataset.action;
          if (action === "delete") {
            btn.addEventListener("click", () => deletePost(btn.dataset.id));
          }
          if (action === "edit") {
            btn.addEventListener("click", () => editPost(btn.dataset.id));
          }
          if (action === "view") {
            btn.addEventListener("click", () => viewPost(btn.dataset.id));
          }
        });
      }

      async function updateComment(commentId) {
        const visitorName = prompt("请输入新昵称（留空则不修改）");
        const content = prompt("请输入新评论内容（留空则不修改）");
        if (visitorName === null && content === null) return;

        const payload = {};
        if (visitorName) payload.visitor_name = visitorName;
        if (content) payload.content = content;
        if (Object.keys(payload).length === 0) {
          setStatus("未填写任何修改内容");
          return;
        }

        setStatus("正在保存评论修改...");
        try {
          const resp = await fetch(`/api/v1/comments/${commentId}`, {
            method: "PUT",
            headers: { "Content-Type": "application/json", ...getHeaders() },
            body: JSON.stringify(payload),
          });
          if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
          const data = await resp.json();
          if (data.code !== 0) throw new Error(data.message || "保存失败");
          await loadComments();
          setStatus("保存完成");
        } catch (err) {
          setStatus(`保存失败：${err.message}`);
        }
      }

      async function deleteComment(commentId) {
        if (!commentId) return;
        if (!confirm(`确定删除评论 ID=${commentId} 吗？`)) return;
        setStatus("正在删除评论...");
        try {
          const resp = await fetch(`/api/v1/comments/${commentId}`, {
            method: "DELETE",
            headers: getHeaders(),
          });
          if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
          const data = await resp.json();
          if (data.code !== 0) throw new Error(data.message || "删除失败");
          await loadComments();
          setStatus("删除完成");
        } catch (err) {
          setStatus(`删除失败：${err.message}`);
        }
      }

      function bindCommentActions() {
        commentsContainer.querySelectorAll("button").forEach((btn) => {
          const action = btn.dataset.action;
          if (action === "comment-edit") {
            btn.addEventListener("click", () => updateComment(btn.dataset.id));
          }
          if (action === "comment-delete") {
            btn.addEventListener("click", () => deleteComment(btn.dataset.id));
          }
        });
      }

      async function refreshActive() {
        if (!isAuthed()) {
          setStatus("请先输入管理端密码");
          return;
        }
        if (activeTab === "posts") return loadPosts();
        return loadComments();
      }

      tabs.forEach((tab) => {
        tab.addEventListener("click", () => {
          setActiveTab(tab.dataset.tab);
          refreshActive();
        });
      });

      document.getElementById("refreshBtn").addEventListener("click", refreshActive);

      setActiveTab("posts");
      refreshActive();
    </script>
  </body>
</html>
