<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>博客管理面板</title>
    <style>
      :root {
        color-scheme: light;
        font-family: "Segoe UI", "PingFang SC", "Microsoft YaHei", Arial, sans-serif;
        --bg: #f7f7fb;
        --card: #ffffff;
        --text: #1f2328;
        --muted: #6b7280;
        --primary: #2563eb;
        --border: #e5e7eb;
      }
      body {
        margin: 0;
        background: var(--bg);
        color: var(--text);
      }
      header {
        background: var(--card);
        border-bottom: 1px solid var(--border);
        padding: 16px 24px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 16px;
        flex-wrap: wrap;
      }
      h1 {
        margin: 0;
        font-size: 20px;
      }
      main {
        padding: 24px;
        display: grid;
        gap: 16px;
      }
      .panel {
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 16px;
      }
      .toolbar {
        display: flex;
        gap: 8px;
        align-items: center;
        flex-wrap: wrap;
      }
      .tabs {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }
      .tab {
        padding: 8px 12px;
        border-radius: 6px;
        border: 1px solid var(--border);
        background: #f3f4f6;
        cursor: pointer;
      }
      .tab.active {
        background: var(--primary);
        color: #fff;
        border-color: var(--primary);
      }
      input[type="text"] {
        padding: 8px 10px;
        border: 1px solid var(--border);
        border-radius: 6px;
        min-width: 240px;
      }
      button {
        padding: 8px 12px;
        border: none;
        border-radius: 6px;
        background: var(--primary);
        color: white;
        cursor: pointer;
      }
      button.secondary {
        background: #6b7280;
      }
      button.danger {
        background: #dc2626;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 12px;
        font-size: 14px;
      }
      th,
      td {
        border-bottom: 1px solid var(--border);
        text-align: left;
        padding: 8px;
        vertical-align: top;
      }
      th {
        background: #f3f4f6;
      }
      .muted {
        color: var(--muted);
      }
      .empty {
        padding: 12px;
        color: var(--muted);
      }
      .badge {
        display: inline-block;
        padding: 2px 8px;
        font-size: 12px;
        border-radius: 999px;
        background: #eef2ff;
        color: #3730a3;
      }
      .hidden {
        display: none;
      }
      .meta {
        color: var(--muted);
        font-size: 13px;
        margin-bottom: 8px;
      }
      .image-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 12px;
        margin-top: 12px;
      }
      .image-grid img {
        width: 100%;
        border-radius: 8px;
        border: 1px solid var(--border);
      }
      .editor {
        margin-top: 16px;
        border-top: 1px dashed var(--border);
        padding-top: 16px;
      }
      .form-row {
        display: grid;
        gap: 8px;
        margin-bottom: 12px;
      }
      .form-row label {
        font-size: 14px;
        color: var(--muted);
        display: flex;
        align-items: center;
        gap: 8px;
      }
      textarea {
        width: 100%;
        min-height: 120px;
        padding: 8px 10px;
        border: 1px solid var(--border);
        border-radius: 6px;
        font-family: inherit;
        resize: vertical;
      }
    </style>
  </head>
  <body>
    <header>
      <h1>博客管理面板</h1>
      <div class="tabs">
        <button class="tab active" data-tab="posts">博客管理</button>
        <button class="tab" data-tab="comments">评论管理</button>
        <button class="tab" data-tab="settings">博客设置</button>
      </div>
    </header>
    <main>
      <section class="panel">
        <div class="toolbar">
          <input id="adminPasswordInput" type="password" placeholder="管理端密码（config.toml）" />
          <button id="refreshBtn">刷新当前列表</button>
          <button id="newPostBtn">新建文章</button>
          <span id="status" class="muted"></span>
        </div>
      </section>

      <section id="postsPanel" class="panel">
        <h2>博客管理</h2>
        <div id="postsContainer" class="empty">暂无数据</div>
      </section>

      <section id="createPostPanel" class="panel hidden">
        <h2>新建文章</h2>
        <div class="form-row">
          <label>标题</label>
          <input id="createTitle" type="text" placeholder="文章标题" />
        </div>
        <div class="form-row">
          <label>摘要 (可选)</label>
          <textarea id="createSummary" rows="3" placeholder="如果不填，将自动截取正文前120字"></textarea>
        </div>
        <div class="form-row">
          <label>正文</label>
          <textarea id="createContent" rows="10" placeholder="支持 Markdown"></textarea>
        </div>
        <div class="form-row">
          <label>图片 (每行一个 URL)</label>
          <textarea id="createImages" rows="3"></textarea>
        </div>
        <div class="form-row">
          <label>上传图片</label>
          <input id="createImageUploadInput" type="file" accept="image/*" multiple />
          <button id="createUploadImageBtn" type="button">上传并追加地址</button>
          <div id="createImageUploadStatus" class="muted"></div>
        </div>
        <div class="form-row">
          <button id="submitNewPostBtn">发布文章</button>
          <button id="cancelNewPostBtn" class="secondary">取消</button>
        </div>
      </section>

      <section id="postDetailPanel" class="panel hidden">
        <h2>文章详情</h2>
        <div id="postDetail" class="empty">请选择文章查看</div>
        <div id="postEditor" class="editor hidden">
          <h3>选择性修改</h3>
          <div class="form-row">
            <label><input class="edit-toggle" data-field="title" type="checkbox" /> 标题</label>
            <input id="editTitle" type="text" />
          </div>
          <div class="form-row">
            <label><input class="edit-toggle" data-field="summary" type="checkbox" /> 摘要</label>
            <textarea id="editSummary" rows="3"></textarea>
          </div>
          <div class="form-row">
            <label><input class="edit-toggle" data-field="content" type="checkbox" /> 正文</label>
            <textarea id="editContent" rows="8"></textarea>
          </div>
          <div class="form-row">
            <label><input class="edit-toggle" data-field="images" type="checkbox" /> 图片（每行一个 URL）</label>
            <textarea id="editImages" rows="4" placeholder="/uploads/images/xxx.png"></textarea>
          </div>
          <div class="form-row">
            <label>上传图片（支持多选）</label>
            <input id="imageUploadInput" type="file" accept="image/*" multiple />
            <button id="uploadImageBtn" type="button">上传图片</button>
            <div id="imageUploadStatus" class="muted"></div>
          </div>
          <div class="form-row">
            <button id="savePostBtn" type="button">保存所选字段</button>
            <button id="clearSelectBtn" type="button" class="secondary">取消选择</button>
          </div>
        </div>
      </section>

      <section id="commentsPanel" class="panel hidden">
        <h2>评论管理</h2>
        <div id="commentsContainer" class="empty">暂无数据</div>
        <div id="commentEditor" class="editor hidden">
          <h3>编辑评论</h3>
          <div class="form-row">
            <label>评论内容</label>
            <textarea id="editCommentContent" rows="5"></textarea>
          </div>
          <div class="form-row">
            <button id="saveCommentBtn" type="button">保存评论</button>
            <button id="cancelCommentBtn" type="button" class="secondary">取消编辑</button>
          </div>
        </div>
      </section>

      <section id="settingsPanel" class="panel hidden">
        <h2>博客设置</h2>
        <div class="form-row">
          <label>博客名称</label>
          <input id="settingName" type="text" placeholder="我的博客" />
        </div>
        <div class="form-row">
          <label>个人简介</label>
          <textarea id="settingIntro" rows="3" placeholder="介绍一下你自己..."></textarea>
        </div>
        <div class="form-row">
          <label>头像 URL</label>
          <div style="display:flex; gap:8px;">
             <input id="settingAvatar" type="text" placeholder="https://..." style="flex:1;" />
             <input id="uploadAvatarInput" type="file" accept="image/*" style="display:none" />
             <button type="button" onclick="document.getElementById('uploadAvatarInput').click()">上传</button>
          </div>
        </div>
        <div class="form-row">
          <label>背景图片 URL</label>
          <div style="display:flex; gap:8px;">
             <input id="settingBg" type="text" placeholder="https://..." style="flex:1;" />
             <input id="uploadBgInput" type="file" accept="image/*" style="display:none" />
             <button type="button" onclick="document.getElementById('uploadBgInput').click()">上传</button>
             <button id="deleteBgBtn" type="button" class="danger">删除</button>
          </div>
        </div>
        <div class="form-row">
          <label>主题色 (Theme Color)</label>
          <input id="settingColor" type="color" value="#2563eb" style="height: 40px; padding: 2px;" />
        </div>
        <div class="form-row">
          <label>节点/锚点颜色 (Node Color)</label>
          <input id="settingNodeColor" type="color" value="#2563eb" style="height: 40px; padding: 2px;" />
        </div>
        <div class="form-row">
          <label>卡片透明度 (Card Opacity: 0.0 - 1.0)</label>
          <input id="settingCardOpacity" type="number" min="0" max="1" step="0.1" value="0.6" />
        </div>
        <div class="form-row">
          <label>
            <input id="settingSnow" type="checkbox" /> 开启雪花特效
          </label>
        </div>
        <div class="form-row">
          <label>背景音乐 URL</label>
          <div style="display:flex; gap:8px;">
             <input id="settingMusic" type="text" placeholder="https://... (mp3/wav/ogg/m4a)" style="flex:1;" />
             <input id="uploadMusicInput" type="file" accept="audio/*" style="display:none" />
             <button type="button" onclick="document.getElementById('uploadMusicInput').click()">上传</button>
             <button id="deleteMusicBtn" type="button" class="danger">删除</button>
          </div>
        </div>
        <div class="form-row">
          <button id="saveSettingsBtn" type="button">保存设置</button>
        </div>
      </section>
    </main>

    <script>
      const adminPasswordInput = document.getElementById("adminPasswordInput");
      const commentsContainer = document.getElementById("commentsContainer");
      const postsContainer = document.getElementById("postsContainer");
      const postDetail = document.getElementById("postDetail");
      const postEditor = document.getElementById("postEditor");
      const statusEl = document.getElementById("status");
      const commentEditor = document.getElementById("commentEditor");
      const editCommentContent = document.getElementById("editCommentContent");
      const saveCommentBtn = document.getElementById("saveCommentBtn");
      const cancelCommentBtn = document.getElementById("cancelCommentBtn");
      const saveSettingsBtn = document.getElementById("saveSettingsBtn");
      const settingName = document.getElementById("settingName");
      const settingIntro = document.getElementById("settingIntro");
      const settingAvatar = document.getElementById("settingAvatar");
      const settingBg = document.getElementById("settingBg");
      const settingColor = document.getElementById("settingColor");
      const settingNodeColor = document.getElementById("settingNodeColor");
      const settingCardOpacity = document.getElementById("settingCardOpacity");
      const settingSnow = document.getElementById("settingSnow");
      const settingMusic = document.getElementById("settingMusic");
      const tabs = document.querySelectorAll(".tab");
      
      // Create Post Elements
      const createPostPanel = document.getElementById("createPostPanel");
      const createTitle = document.getElementById("createTitle");
      const createSummary = document.getElementById("createSummary");
      const createContent = document.getElementById("createContent");
      const createImages = document.getElementById("createImages");
      const createImageUploadInput = document.getElementById("createImageUploadInput");
      const createUploadImageBtn = document.getElementById("createUploadImageBtn");
      const createImageUploadStatus = document.getElementById("createImageUploadStatus");
      const submitNewPostBtn = document.getElementById("submitNewPostBtn");
      const cancelNewPostBtn = document.getElementById("cancelNewPostBtn");
      const newPostBtn = document.getElementById("newPostBtn");

      // Settings Upload Elements
      const uploadAvatarInput = document.getElementById("uploadAvatarInput");
      const uploadBgInput = document.getElementById("uploadBgInput");
      const deleteBgBtn = document.getElementById("deleteBgBtn");
      const uploadMusicInput = document.getElementById("uploadMusicInput");
      const deleteMusicBtn = document.getElementById("deleteMusicBtn");

      const panels = {
        posts: document.getElementById("postsPanel"),
        comments: document.getElementById("commentsPanel"),
        settings: document.getElementById("settingsPanel"),
      };
      const editTitleInput = document.getElementById("editTitle");
      const editSummaryInput = document.getElementById("editSummary");
      const editContentInput = document.getElementById("editContent");
      const editImagesInput = document.getElementById("editImages");
      const imageUploadInput = document.getElementById("imageUploadInput");
      const imageUploadStatus = document.getElementById("imageUploadStatus");
      const savePostBtn = document.getElementById("savePostBtn");
      const clearSelectBtn = document.getElementById("clearSelectBtn");
      const uploadImageBtn = document.getElementById("uploadImageBtn");
      let activeTab = "posts";
      let currentPostId = null;
      let currentPost = null;
      let currentCommentId = null;

      function setStatus(text) {
        statusEl.textContent = text;
      }

      function getHeaders() {
        const password = adminPasswordInput.value.trim();
        return password ? { "X-ADMIN-PASSWORD": password } : {};
      }

      function isAuthed() {
        return !!adminPasswordInput.value.trim();
      }

      function setActiveTab(tabName) {
        activeTab = tabName;
        tabs.forEach((tab) => {
          tab.classList.toggle("active", tab.dataset.tab === tabName);
        });
        Object.entries(panels).forEach(([key, panel]) => {
          panel.classList.toggle("hidden", key !== tabName);
        });
        // Hide auxiliary panels when switching tabs
        document.getElementById("postDetailPanel").classList.add("hidden");
        document.getElementById("createPostPanel").classList.add("hidden");
      }

      function renderTable(container, rows, columns) {
        if (!rows || rows.length === 0) {
          container.innerHTML = "<div class='empty'>暂无数据</div>";
          return;
        }
        const thead = `<thead><tr>${columns.map((c) => `<th>${c.title}</th>`).join("")}</tr></thead>`;
        const tbody = `<tbody>${rows
          .map((row) => {
            return `<tr>${columns
              .map((c) => `<td>${c.render ? c.render(row) : row[c.key] ?? ""}</td>`)
              .join("")}</tr>`;
          })
          .join("")}</tbody>`;
        container.innerHTML = `<table>${thead}${tbody}</table>`;
      }

      function parseImages(value) {
        if (!value) return [];
        return value
          .split("\n")
          .map((item) => item.trim())
          .filter((item) => item.length > 0);
      }

      function renderImages(images) {
        if (!images || images.length === 0) return "";
        const items = images
          .map((url) => `<div><img src="${url}" alt="image" /></div>`)
          .join("");
        return `<div class="image-grid">${items}</div>`;
      }

      function fillEditor(post) {
        if (!post) return;
        editTitleInput.value = post.title || "";
        editSummaryInput.value = post.summary || "";
        editContentInput.value = post.content || "";
        editImagesInput.value = (post.images || []).join("\n");
        postEditor.classList.remove("hidden");
      }

      function clearEditSelection() {
        document.querySelectorAll(".edit-toggle").forEach((checkbox) => {
          checkbox.checked = false;
        });
      }

      async function loadComments() {
        setStatus("正在加载评论列表...");
        try {
          const resp = await fetch(`/api/v1/comments`, { headers: getHeaders() });
          if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
          const data = await resp.json();
          renderTable(commentsContainer, data.data || [], [
            { title: "ID", key: "id" },
            { title: "文章", key: "post_title" },
            { title: "评论", key: "content" },
            { title: "时间", key: "created_at" },
            {
              title: "操作",
              render: (row) => `
                <button data-action='comment-edit' data-id='${row.id}'>编辑</button>
                <button class='danger' data-action='comment-delete' data-id='${row.id}'>删除</button>
              `,
            },
          ]);
          bindCommentActions();
          bindCommentRowClicks();
          setStatus("评论列表加载完成");
        } catch (err) {
          commentsContainer.innerHTML = `<div class='empty'>加载失败：${err.message}</div>`;
          setStatus("加载失败");
        }
      }

      async function loadPosts() {
        setStatus("正在加载博客列表...");
        try {
          // Fetch up to 100 posts for admin management
          const resp = await fetch(`/api/v1/posts?size=100`, { headers: getHeaders() });
          if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
          const data = await resp.json();
          renderTable(postsContainer, data.data || [], [
            { title: "ID", key: "id" },
            { title: "标题", key: "title" },
            { title: "时间", key: "created_at" },
            {
              title: "操作",
              render: (row) => `
                <button data-action='view' data-id='${row.id}'>查看</button>
                <button data-action='edit' data-id='${row.id}'>编辑</button>
                <button class='danger' data-action='delete' data-id='${row.id}'>删除</button>
              `,
            },
          ]);
          bindPostActions();
          bindPostRowClicks();
          setStatus("博客列表加载完成");
        } catch (err) {
          postsContainer.innerHTML = `<div class='empty'>加载失败：${err.message}</div>`;
          setStatus("加载失败");
        }
      }

      async function deletePost(postId) {
        if (!postId) return;
        if (!confirm(`确定删除文章 ID=${postId} 吗？`)) return;
        setStatus("正在删除文章...");
        try {
          const resp = await fetch(`/api/v1/posts/${postId}`, {
            method: "DELETE",
            headers: getHeaders(),
          });
          if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
          const data = await resp.json();
          if (data.code !== 0) throw new Error(data.message || "删除失败");
          await loadPosts();
          setStatus("删除完成");
        } catch (err) {
          setStatus(`删除失败：${err.message}`);
        }
      }

      async function viewPost(postId) {
        if (!postId) return;
        setStatus("正在加载文章详情...");
        try {
          const resp = await fetch(`/api/v1/posts/${postId}`, { headers: getHeaders() });
          if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
          const data = await resp.json();
          if (!data.data) throw new Error("未找到文章");
          const post = data.data;
          currentPostId = post.id;
          currentPost = post;
          postDetail.innerHTML = `
            <div class="meta">ID：${post.id} ｜ 时间：${post.created_at || ""}</div>
            <div class="meta"><a href="/post/${post.id}" target="_blank" rel="noopener">新窗口查看原文</a></div>
            <h3>${post.title || ""}</h3>
            <p>${post.summary || ""}</p>
            <pre style="white-space: pre-wrap;">${post.content || ""}</pre>
            ${renderImages(post.images || [])}
          `;
          fillEditor(post);
          clearEditSelection();
          document.getElementById("postDetailPanel").classList.remove("hidden");
          document.getElementById("postDetailPanel").scrollIntoView({ behavior: "smooth", block: "start" });
          setStatus("文章详情加载完成");
        } catch (err) {
          postDetail.innerHTML = `<div class='empty'>加载失败：${err.message}</div>`;
          postEditor.classList.add("hidden");
          setStatus("加载失败");
        }
      }

      async function editPost(postId) {
        await viewPost(postId);
        postEditor.scrollIntoView({ behavior: "smooth", block: "start" });
      }

      function bindPostActions() {
        postsContainer.querySelectorAll("button").forEach((btn) => {
          const action = btn.dataset.action;
          // Remove existing listeners to prevent duplicates if re-bound (though innerHTML replacement handles this usually)
          // Using cloneNode to strip listeners is a heavy-handed approach, but here we rely on fresh DOM from renderTable.
          // Just binding directly is fine as long as we don't double-bind on the same element.
          
          if (action === "delete") {
            btn.onclick = (e) => {
              e.stopPropagation(); // Prevent row click
              deletePost(btn.dataset.id);
            };
          }
          if (action === "edit") {
            btn.onclick = (e) => {
              e.stopPropagation(); // Prevent row click
              editPost(btn.dataset.id);
            };
          }
          if (action === "view") {
            btn.onclick = (e) => {
              e.stopPropagation(); // Prevent row click
              viewPost(btn.dataset.id);
            };
          }
        });
      }

      async function saveSelectedFields() {
        if (!currentPostId) {
          setStatus("请先选择文章");
          return;
        }
        const payload = {};
        document.querySelectorAll(".edit-toggle").forEach((checkbox) => {
          if (!checkbox.checked) return;
          const field = checkbox.dataset.field;
          if (field === "title") payload.title = editTitleInput.value.trim();
          if (field === "summary") payload.summary = editSummaryInput.value;
          if (field === "content") payload.content = editContentInput.value;
          if (field === "images") payload.images = parseImages(editImagesInput.value);
        });

        if (Object.keys(payload).length === 0) {
          setStatus("未勾选任何要修改的字段");
          return;
        }

        setStatus("正在保存修改...");
        try {
          const resp = await fetch(`/api/v1/posts/${currentPostId}`, {
            method: "PUT",
            headers: { "Content-Type": "application/json", ...getHeaders() },
            body: JSON.stringify(payload),
          });
          if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
          const data = await resp.json();
          if (data.code !== 0) throw new Error(data.message || "保存失败");
          await loadPosts();
          await viewPost(currentPostId);
          setStatus("保存完成");
        } catch (err) {
          setStatus(`保存失败：${err.message}`);
        }
      }

      async function uploadImages() {
        if (!imageUploadInput.files || imageUploadInput.files.length === 0) {
          imageUploadStatus.textContent = "请先选择图片";
          return;
        }
        imageUploadStatus.textContent = "正在上传...";
        const urls = [];
        for (const file of imageUploadInput.files) {
          const formData = new FormData();
          formData.append("file", file);
          const resp = await fetch("/api/v1/uploads/image", {
            method: "POST",
            headers: getHeaders(),
            body: formData,
          });
          if (!resp.ok) {
            imageUploadStatus.textContent = `上传失败：HTTP ${resp.status}`;
            return;
          }
          const data = await resp.json();
          if (data.code !== 0) {
            imageUploadStatus.textContent = `上传失败：${data.message || "error"}`;
            return;
          }
          urls.push(data.data.url);
        }
        const existing = parseImages(editImagesInput.value);
        editImagesInput.value = [...existing, ...urls].join("\n");
        imageUploadStatus.textContent = "上传完成";
      }

      function openCommentEditor(comment) {
        currentCommentId = comment?.id ?? null;
        editCommentContent.value = comment?.content || "";
        commentEditor.classList.remove("hidden");
        commentEditor.scrollIntoView({ behavior: "smooth", block: "start" });
      }

      function closeCommentEditor() {
        currentCommentId = null;
        editCommentContent.value = "";
        commentEditor.classList.add("hidden");
      }

      async function updateComment() {
        if (!currentCommentId) {
          setStatus("请先选择评论");
          return;
        }
        const content = editCommentContent.value.trim();

        const payload = {};
        if (content) payload.content = content;
        if (Object.keys(payload).length === 0) {
          setStatus("未填写任何修改内容");
          return;
        }

        setStatus("正在保存评论修改...");
        try {
          const resp = await fetch(`/api/v1/comments/${currentCommentId}`, {
            method: "PUT",
            headers: { "Content-Type": "application/json", ...getHeaders() },
            body: JSON.stringify(payload),
          });
          if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
          const data = await resp.json();
          if (data.code !== 0) throw new Error(data.message || "保存失败");
          await loadComments();
          closeCommentEditor();
          setStatus("保存完成");
        } catch (err) {
          setStatus(`保存失败：${err.message}`);
        }
      }

      async function deleteComment(commentId) {
        if (!commentId) return;
        if (!confirm(`确定删除评论 ID=${commentId} 吗？`)) return;
        setStatus("正在删除评论...");
        try {
          const resp = await fetch(`/api/v1/comments/${commentId}`, {
            method: "DELETE",
            headers: getHeaders(),
          });
          if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
          const data = await resp.json();
          if (data.code !== 0) throw new Error(data.message || "删除失败");
          await loadComments();
          setStatus("删除完成");
        } catch (err) {
          setStatus(`删除失败：${err.message}`);
        }
      }

      function bindCommentActions() {
        commentsContainer.querySelectorAll("button").forEach((btn) => {
          const action = btn.dataset.action;
          if (action === "comment-edit") {
            btn.addEventListener("click", () => {
              const row = btn.closest("tr");
              const contentCell = row?.querySelector("td:nth-child(3)");
              openCommentEditor({ id: btn.dataset.id, content: contentCell?.textContent || "" });
            });
          }
          if (action === "comment-delete") {
            btn.addEventListener("click", () => deleteComment(btn.dataset.id));
          }
        });
      }

      function bindCommentRowClicks() {
        commentsContainer.querySelectorAll("tbody tr").forEach((row) => {
          row.addEventListener("click", (event) => {
            if (event.target.tagName === "BUTTON") return;
            const idCell = row.querySelector("td:nth-child(1)");
            const contentCell = row.querySelector("td:nth-child(3)");
            const commentId = idCell?.textContent?.trim();
            if (!commentId) return;
            openCommentEditor({ id: commentId, content: contentCell?.textContent || "" });
          });
        });
      }

      function bindPostRowClicks() {
        postsContainer.querySelectorAll("tbody tr").forEach((row) => {
          row.addEventListener("click", (event) => {
            if (event.target.tagName === "BUTTON") return;
            const idCell = row.querySelector("td:nth-child(1)");
            const postId = idCell?.textContent?.trim();
            if (!postId) return;
            editPost(postId);
          });
        });
      }

      async function loadSettings() {
        setStatus("正在加载设置...");
        try {
          const resp = await fetch(`/api/v1/settings`, { headers: getHeaders() });
          if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
          const res = await resp.json();
          const data = res.data || {};
          settingName.value = data.name || "";
          settingIntro.value = data.intro || "";
          settingAvatar.value = data.avatar || "";
          settingBg.value = data.background_image || "";
          settingColor.value = data.theme_color || "#2563eb";
          settingNodeColor.value = data.node_color || "#2563eb";
          settingCardOpacity.value = data.card_opacity !== undefined ? data.card_opacity : 0.6;
          settingSnow.checked = !!data.enable_snow;
          settingMusic.value = data.music_url || "";
          setStatus("设置加载完成");
        } catch (err) {
          setStatus(`加载设置失败：${err.message}`);
        }
      }

      // Generic Upload Helper
      async function uploadFile(fileInput, targetInput, type = "image", statusEl) {
        if (!fileInput.files || fileInput.files.length === 0) return;
        if (statusEl) statusEl.textContent = "正在上传...";
        
        const file = fileInput.files[0];
        const formData = new FormData();
        formData.append("file", file);

        const endpoint = type === "music" ? "/api/v1/uploads/music" : "/api/v1/uploads/image";

        try {
          const resp = await fetch(endpoint, {
            method: "POST",
            headers: getHeaders(),
            body: formData,
          });
          if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
          const data = await resp.json();
          if (data.code !== 0) throw new Error(data.message || "上传失败");
          
          targetInput.value = data.data.url;
          if (statusEl) statusEl.textContent = "上传成功";
          else alert("上传成功");
        } catch (err) {
          if (statusEl) statusEl.textContent = `上传失败: ${err.message}`;
          else alert(`上传失败: ${err.message}`);
        }
      }

      async function deleteBgImage() {
        const currentUrl = settingBg.value.trim();
        if (!currentUrl) return;
        
        // Only delete if it's a local upload
        if (!currentUrl.startsWith("/uploads/images/")) {
          settingBg.value = "";
          alert("已清除背景图片链接（非本地文件，未执行物理删除）");
          return;
        }

        if (!confirm("确定要删除当前的背景图片文件吗？此操作不可恢复。")) return;

        const filename = currentUrl.split("/").pop();
        try {
          const resp = await fetch(`/api/v1/uploads/images/${filename}`, {
            method: "DELETE",
            headers: getHeaders(),
          });
          if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
          const data = await resp.json();
          if (data.code !== 0) throw new Error(data.message || "删除失败");
          
          settingBg.value = "";
          alert("背景图片已删除");
        } catch (err) {
          alert(`删除失败: ${err.message}`);
        }
      }

      async function deleteMusic() {
        const currentUrl = settingMusic.value.trim();
        if (!currentUrl) return;
        
        // Only delete if it's a local upload
        if (!currentUrl.startsWith("/uploads/music/")) {
          settingMusic.value = "";
          alert("已清除音乐链接（非本地文件，未执行物理删除）");
          return;
        }

        if (!confirm("确定要删除当前的音乐文件吗？此操作不可恢复。")) return;

        const filename = currentUrl.split("/").pop();
        try {
          const resp = await fetch(`/api/v1/uploads/music/${filename}`, {
            method: "DELETE",
            headers: getHeaders(),
          });
          if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
          const data = await resp.json();
          if (data.code !== 0) throw new Error(data.message || "删除失败");
          
          settingMusic.value = "";
          alert("音乐文件已删除");
        } catch (err) {
          alert(`删除失败: ${err.message}`);
        }
      }

      async function uploadCreateImages() {
        if (!createImageUploadInput.files || createImageUploadInput.files.length === 0) {
          createImageUploadStatus.textContent = "请先选择图片";
          return;
        }
        createImageUploadStatus.textContent = "正在上传...";
        const urls = [];
        for (const file of createImageUploadInput.files) {
          const formData = new FormData();
          formData.append("file", file);
          try {
            const resp = await fetch("/api/v1/uploads/image", {
              method: "POST",
              headers: getHeaders(),
              body: formData,
            });
            if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
            const data = await resp.json();
            if (data.code !== 0) throw new Error(data.message);
            urls.push(data.data.url);
          } catch (err) {
            createImageUploadStatus.textContent = `部分上传失败: ${err.message}`;
          }
        }
        const existing = parseImages(createImages.value);
        createImages.value = [...existing, ...urls].join("\n");
        createImageUploadStatus.textContent = "上传完成";
      }

      async function submitNewPost() {
        const title = createTitle.value.trim();
        const content = createContent.value.trim();
        if (!title || !content) {
          alert("标题和正文不能为空");
          return;
        }
        
        setStatus("正在发布...");
        const payload = {
          title,
          content,
          summary: createSummary.value.trim() || null,
          images: parseImages(createImages.value)
        };

        try {
          const resp = await fetch("/api/v1/posts", {
            method: "POST",
            headers: { "Content-Type": "application/json", ...getHeaders() },
            body: JSON.stringify(payload),
          });
          if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
          const data = await resp.json();
          if (data.code !== 0) throw new Error(data.message);
          
          alert("发布成功！");
          createTitle.value = "";
          createSummary.value = "";
          createContent.value = "";
          createImages.value = "";
          createImageUploadInput.value = "";
          createPostPanel.classList.add("hidden");
          postsContainer.classList.remove("hidden");
          await loadPosts();
        } catch (err) {
          setStatus(`发布失败: ${err.message}`);
          alert(`发布失败: ${err.message}`);
        }
      }

      function showCreatePanel() {
        createPostPanel.classList.remove("hidden");
        document.getElementById("postDetailPanel").classList.add("hidden");
        createPostPanel.scrollIntoView({ behavior: "smooth" });
      }

      function hideCreatePanel() {
        createPostPanel.classList.add("hidden");
      }

      async function saveSettings() {
        setStatus("正在保存设置...");
        const payload = {
          name: settingName.value.trim(),
          intro: settingIntro.value,
          avatar: settingAvatar.value.trim(),
          background_image: settingBg.value.trim(),
          theme_color: settingColor.value,
          node_color: settingNodeColor.value,
          card_opacity: parseFloat(settingCardOpacity.value),
          enable_snow: settingSnow.checked,
          music_url: settingMusic.value.trim(),
        };
        try {
          const resp = await fetch(`/api/v1/settings`, {
            method: "POST",
            headers: { "Content-Type": "application/json", ...getHeaders() },
            body: JSON.stringify(payload),
          });
          if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
          const data = await resp.json();
          if (data.code !== 0) throw new Error(data.message || "保存失败");
          setStatus("设置已保存");
        } catch (err) {
          setStatus(`保存设置失败：${err.message}`);
        }
      }

      async function refreshActive() {
        console.log("refreshActive called, tab:", activeTab);
        if (!isAuthed()) {
          setStatus("请先输入管理端密码");
          alert("请先输入管理端密码");
          return;
        }
        try {
          if (activeTab === "posts") await loadPosts();
          else if (activeTab === "comments") await loadComments();
          else if (activeTab === "settings") await loadSettings();
        } catch (e) {
          console.error(e);
          alert("操作失败: " + e.message);
        }
      }

      tabs.forEach((tab) => {
        tab.addEventListener("click", () => {
          setActiveTab(tab.dataset.tab);
          refreshActive();
        });
      });

      document.getElementById("refreshBtn").addEventListener("click", () => {
        console.log("Refresh clicked");
        refreshActive();
      });
      savePostBtn.addEventListener("click", saveSelectedFields);
      clearSelectBtn.addEventListener("click", clearEditSelection);
      uploadImageBtn.addEventListener("click", uploadImages);
      saveCommentBtn.addEventListener("click", updateComment);
      cancelCommentBtn.addEventListener("click", closeCommentEditor);
      saveSettingsBtn.addEventListener("click", saveSettings);
      
      // New Event Listeners
      newPostBtn.addEventListener("click", showCreatePanel);
      cancelNewPostBtn.addEventListener("click", hideCreatePanel);
      submitNewPostBtn.addEventListener("click", submitNewPost);
      createUploadImageBtn.addEventListener("click", uploadCreateImages);
      
      uploadAvatarInput.addEventListener("change", () => uploadFile(uploadAvatarInput, settingAvatar, "image"));
      uploadBgInput.addEventListener("change", () => uploadFile(uploadBgInput, settingBg, "image"));
      deleteBgBtn.addEventListener("click", deleteBgImage);
      uploadMusicInput.addEventListener("change", () => uploadFile(uploadMusicInput, settingMusic, "music"));
      deleteMusicBtn.addEventListener("click", deleteMusic);

      setActiveTab("posts");
      refreshActive();
    </script>
  </body>
</html>
